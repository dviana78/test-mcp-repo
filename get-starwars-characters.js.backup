const { exec } = require('child_process');
const util = require('util');
const execPromise = util.promisify(exec);

console.log('ğŸŒŸ Obteniendo Personajes de Star Wars');
console.log('=====================================');

async function getStarWarsCharacters() {
    console.log('ğŸ” MÃ©todo 1: Acceso directo al backend original...');
    
    try {
        // Usar curl para obtener datos directamente del backend
        const { stdout, stderr } = await execPromise('curl -s https://swapi.dev/api/people/');
        
        if (stderr) {
            console.log('âš ï¸ Error con curl:', stderr);
            return;
        }

        const data = JSON.parse(stdout);
        console.log(`âœ… Ã‰xito! Encontrados ${data.count} personajes`);
        console.log('\nğŸ‘¥ Personajes de Star Wars:');
        console.log('===========================');
        
        // Mostrar los primeros personajes
        data.results.forEach((character, index) => {
            console.log(`${index + 1}. ${character.name}`);
            console.log(`   ğŸ  Planeta: ${character.homeworld.split('/').slice(-2, -1)[0] || 'Desconocido'}`);
            console.log(`   ğŸ‘ï¸ Color de ojos: ${character.eye_color}`);
            console.log(`   ğŸ­ GÃ©nero: ${character.gender}`);
            console.log('');
        });

        // Si hay mÃ¡s pÃ¡ginas, obtener algunos personajes adicionales
        if (data.next) {
            console.log('ğŸ“„ Obteniendo mÃ¡s personajes...');
            const { stdout: page2 } = await execPromise('curl -s https://swapi.dev/api/people/?page=2');
            const data2 = JSON.parse(page2);
            
            console.log('\nğŸ‘¥ MÃ¡s personajes:');
            console.log('==================');
            data2.results.slice(0, 5).forEach((character, index) => {
                console.log(`${index + 11}. ${character.name}`);
                console.log(`   ğŸ  Planeta: ${character.homeworld.split('/').slice(-2, -1)[0] || 'Desconocido'}`);
                console.log(`   ğŸ‘ï¸ Color de ojos: ${character.eye_color}`);
                console.log(`   ï¿½ GÃ©nero: ${character.gender}`);
                console.log('');
            });
        }

        console.log('ğŸ’¡ Nota sobre APIM:');
        console.log('===================');
        console.log('La API de Star Wars estÃ¡ funcionando perfectamente en el backend original.');
        console.log('El problema estÃ¡ en la configuraciÃ³n de Azure APIM que necesita ajustes.');
        console.log('Para solucionarlo, se necesita:');
        console.log('1. Verificar la configuraciÃ³n del Service URL');
        console.log('2. Configurar las polÃ­ticas de rewrite de URL');
        console.log('3. Asegurar que los endpoints estÃ©n mapeados correctamente');

    } catch (error) {
        console.log('âŒ Error obteniendo personajes:', error.message);
        console.log('ğŸ”„ Intentando mÃ©todo alternativo...');
        
        // MÃ©todo alternativo usando Node.js
        const https = require('https');
        
        return new Promise((resolve, reject) => {
            const options = {
                hostname: 'swapi.dev',
                port: 443,
                path: '/api/people/',
                method: 'GET'
            };

            const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => {
                    data += chunk;
                });
                
                res.on('end', () => {
                    try {
                        const jsonData = JSON.parse(data);
                        console.log(`âœ… MÃ©todo alternativo exitoso! ${jsonData.count} personajes`);
                        
                        console.log('\nï¿½ Personajes de Star Wars:');
                        console.log('===========================');
                        jsonData.results.forEach((character, index) => {
                            console.log(`${index + 1}. ${character.name}`);
                            console.log(`   ğŸ¬ Apariciones: ${character.films.length} pelÃ­culas`);
                            console.log(`   ğŸ“ Altura: ${character.height} cm`);
                            console.log('');
                        });
                        resolve();
                    } catch (err) {
                        reject(err);
                    }
                });
            });

            req.on('error', reject);
            req.end();
        });
    }
}

getStarWarsCharacters().catch(console.error);