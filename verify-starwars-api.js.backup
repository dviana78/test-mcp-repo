const { spawn } = require('child_process');

console.log('🔍 Verificando Configuración de la API de Star Wars');
console.log('==================================================\n');

const server = spawn('node', ['dist/index.js'], {
  stdio: ['pipe', 'pipe', 'pipe'],
  cwd: process.cwd()
});

let buffer = '';
let requestId = 1;

function sendRequest(method, params = {}) {
  const request = {
    jsonrpc: '2.0',
    id: requestId++,
    method: method,
    params: params
  };
  
  console.log(`📤 Enviando: ${method}`);
  server.stdin.write(JSON.stringify(request) + '\n');
}

server.stdout.on('data', (data) => {
  buffer += data.toString();
  
  const lines = buffer.split('\n');
  buffer = lines.pop();
  
  lines.forEach(line => {
    if (line.trim()) {
      try {
        const response = JSON.parse(line);
        
        if (response.result) {
          if (response.result.serverInfo) {
            console.log('✅ Servidor MCP inicializado\n');
          } else if (response.result.content) {
            response.result.content.forEach(content => {
              if (content.text) {
                try {
                  const data = JSON.parse(content.text);
                  
                  if (data.api) {
                    console.log('📋 Configuración de la API:');
                    console.log(`   ID: ${data.api.id}`);
                    console.log(`   Nombre: ${data.api.displayName}`);
                    console.log(`   Path: ${data.api.path}`);
                    console.log(`   Service URL: ${data.api.serviceUrl}`);
                    console.log(`   Protocolos: ${data.api.protocols?.join(', ')}`);
                    console.log(`   Suscripción requerida: ${data.api.subscriptionRequired ? 'Sí' : 'No'}`);
                    
                    // Construir URL completa
                    const baseUrl = `https://apim-dviana78-dev.azure-api.net`;
                    const fullPath = data.api.path ? `/${data.api.path}` : '';
                    console.log(`   🌐 URL Base: ${baseUrl}${fullPath}`);
                  } else if (data.operations) {
                    console.log('\n🔧 Operaciones disponibles:');
                    data.operations.forEach((op, index) => {
                      console.log(`   ${index + 1}. ${op.method} ${op.urlTemplate || op.path}`);
                      console.log(`      Nombre: ${op.displayName || op.name}`);
                    });
                  } else if (data.subscription) {
                    console.log('\n🔑 Detalles de la suscripción:');
                    console.log(`   ID: ${data.subscription.id}`);
                    console.log(`   Estado: ${data.subscription.state}`);
                    console.log(`   Clave primaria: ${data.subscription.primaryKey || 'No visible'}`);
                  }
                } catch (e) {
                  console.log('📝 Respuesta:', content.text);
                }
              }
            });
          }
        } else if (response.error) {
          console.log(`❌ Error: ${response.error.message}`);
        }
      } catch (e) {
        // Ignorar líneas que no son JSON válidas
      }
    }
  });
});

server.stderr.on('data', (data) => {
  console.log('🚨 Error:', data.toString());
});

server.on('close', (code) => {
  console.log(`\n💡 Información para acceder a la API:`);
  console.log('=====================================');
  console.log('1. URL Base: https://apim-dviana78-dev.azure-api.net/swapi/v1');
  console.log('2. Header: Ocp-Apim-Subscription-Key: [tu-clave]');
  console.log('3. Endpoints: /people, /planets, /films, etc.');
  console.log('\n🔍 Si el endpoint no funciona, es posible que:');
  console.log('   - La API esté configurada incorrectamente');
  console.log('   - El servicio backend no esté respondiendo');
  console.log('   - Se necesite una configuración adicional en APIM');
  console.log(`\n🔚 Proceso completado con código: ${code}`);
});

// Secuencia de verificación
setTimeout(() => {
  sendRequest('initialize', {
    protocolVersion: '2024-11-05',
    capabilities: {},
    clientInfo: { name: 'verify-api', version: '1.0.0' }
  });
}, 500);

setTimeout(() => {
  console.log('🔍 Obteniendo detalles de la API...');
  sendRequest('tools/call', {
    name: 'get_api',
    arguments: {
      apiId: 'star-wars-api'
    }
  });
}, 3000);

setTimeout(() => {
  console.log('\n🔧 Obteniendo operaciones de la API...');
  sendRequest('tools/call', {
    name: 'get_api_operations',
    arguments: {
      apiId: 'star-wars-api'
    }
  });
}, 6000);

setTimeout(() => {
  console.log('\n🔑 Verificando suscripción...');
  sendRequest('tools/call', {
    name: 'get_subscription',
    arguments: {
      subscriptionId: 'star-wars-subscription'
    }
  });
}, 9000);

setTimeout(() => {
  server.kill();
}, 12000);